# Energy from ten_lessons using 7nm

arch:
  version: "0.5"
  global_cycle_period: 1e-9
  nodes:
  - !Memory
    name: MainMemory
    attributes:
      _size: inf
      _bandwidth_reads_plus_writes_per_cycle: 256 # 256 GB/s
      # width: 256
      _datawidth: 8
    actions:
      # Upper end of the range from the TPU paper. The lower end came from their
      # reference, and they said it left out some things.
    - {name: read, arguments: {energy: 7.03e-12, bits_per_action: 8}} # 56.24 pJ/8b
    - {name: write, arguments: {energy: 7.03e-12, bits_per_action: 8}}
    - {name: leak, arguments: {energy: 0}}
    constraints:
      tensors:
        keep: ~Intermediates()

  - !Memory
    name: GlobalBuffer
    attributes:
      _size: 1024*1024*1*8 # 1 MiB
      _datawidth: 8
      _bandwidth_reads_plus_writes_per_cycle: 512 # 512 GB/s
    actions:
    - {name: read, arguments: {energy: 0.249e-12, bits_per_action: 8}} # 15.04pJ/8b-read
    - {name: write, arguments: {energy: 0.293e-12, bits_per_action: 8}} # 18.88pJ/8b-read
    - {name: leak, arguments: {energy: 0}}
    constraints:
      tensors:
        keep: ~MainMemory.tensors() | input | output

  - !Memory
    name: LocalBuffer
    spatial: [{name: Z, fanout: 4}]
    attributes:
      _size: 1024*128*8 # 128 KiB
      _bandwidth_reads_plus_writes_per_cycle: 1024 # 1024 GB/s
      _datawidth: 8
    actions:
    - {name: read, arguments: {energy: 0.249e-12, bits_per_action: 8}} # 2.00 pJ/8b
    - {name: write, arguments: {energy: 0.293e-12, bits_per_action: 8}} # 2.32 pJ/8b
    - {name: leak, arguments: {energy: 0}}
    constraints:
      tensors:
        keep: (Intermediates() - weight) - GlobalBuffer.tensors()
        bypass: weight | GlobalBuffer.tensors()
      spatial:
      - name: Z
        min_utilization: 1 if len(All()) > 2 else 0
        loop_bounds:
        - expression: weight.rank_variables()
          operator: ==
          value: 1

  - !Compute
    name: scalar_unit
    attributes:
      _computes_per_cycle: 128
    actions:
    - {name: compute, arguments: {energy: 0}}
    - {name: leak, arguments: {energy: 0}}
    constraints: {misc: {enabled: len(All()) == 2}}

  - !Memory
    name: Register
    spatial: [{name: X, fanout: 128}, {name: Y, fanout: 128}]
    attributes:
      _size: 8 # 8b
      _datawidth: 8
      _area: 1
    actions:
    - {name: read, arguments: {energy: 0}}
    - {name: write, arguments: {energy: 0}}
    - {name: leak, arguments: {energy: 0}}
    constraints:
      tensors:
        keep: weight - GlobalBuffer.tensors()
        bypass: ~weight | GlobalBuffer.tensors()
      spatial:
      - name: X # Parallel rank
        min_utilization: 1
        loop_bounds:
        - expression: input.rank_variables() | ~output.rank_variables()
          operator: ==
          value: 1
      - name: Y # Reduced rank. No iteration over outputs
        min_utilization: 1
        loop_bounds:
        - expression: output.rank_variables() | ~input.rank_variables()
          operator: ==
          value: 1

  - !Compute
    name: MAC
    actions:
    - {name: compute, arguments: {energy: 0.07e-12}}
    - {name: leak, arguments: {energy: 0}}
    constraints: {misc: {enabled: len(All()) == 3}}
