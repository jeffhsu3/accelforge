arch:
  version: "0.5"
  nodes:
  - !Memory
    name: MainMemory
    attributes:
      _size: inf
      _datawidth: 8
      _latency: (read_actions + write_actions) / (8 * 614e9) # 614 GB/s
      _leak_power: 0
      _area: 0
    actions:
      # Upper end of the range from the TPU paper. The lower end came from their
      # reference, and they said it left out some things.
    - {name: read, arguments: {energy: 7.03e-12}}
    - {name: write, arguments: {energy: 7.03e-12}}
    constraints:
      tensors:
        keep: ~Intermediates()

  - !Memory
    name: GlobalBuffer
    attributes:
      _size: 1024*1024*128*8 # 128MB
      _datawidth: 8
      _latency: max(read_actions / 8 * 2048e9, write_actions / 8 * 1024e9) # 2GB/s read, 1GB/s write
      _leak_power: 0
      _area: 0
    actions:
    - {name: read, arguments: {energy: 1.88e-12}}
    - {name: write, arguments: {energy: 2.36e-12}}
    constraints:
      tensors:
        keep: ~MainMemory.tensors()
        no_refetch_from_above: Intermediates() if ~MainMemory.tensors() else Nothing()

  - !Memory
    name: LocalBuffer
    spatial: [{name: Z, fanout: 4, reuse: Nothing}]
    attributes:
      _size: 1024*1024*4*8 # 4MB
      _datawidth: 8
      _leak_power: 0
      _area: 0
    actions:
    - {name: read, arguments: {energy: 0.249e-12}}
    - {name: write, arguments: {energy: 0.293e-12}}
    constraints:
      tensors: {bypass: weight, keep: input | output}

  - !Compute
    name: scalar_unit
    attributes:
      _latency: compute_actions / 128e9,
      _leak_power: 0
      _area: 0
    actions:
    - {name: compute, arguments: {energy: 0}}
    constraints: {misc: {enabled: len(All()) == 2}}

  - !Memory
    name: Register
    spatial:
    - {name: X, fanout: 128, reuse: input}
    - {name: Y, fanout: 128, reuse: output}
    attributes:
      _size: 8 # 8b
      _datawidth: 8
      _leak_power: 0
      _area: 0
    actions:
    - {name: read, arguments: {energy: 0}}
    - {name: write, arguments: {energy: 0}}
    constraints:
      tensors: {bypass: ~weight, keep: weight}
      spatial:
      - name: X # Parallel rank
        min_utilization: 1
        loop_bounds:
        - expression: input.rank_variables()
          operator: ==
          value: 1
      - name: Y # Reduced rank. No iteration over outputs
        min_utilization: 1
        loop_bounds:
        - expression: output.rank_variables()
          operator: ==
          value: 1

  - !Compute
    name: MAC
    attributes:
      _latency: compute_actions
      _leak_power: 0
      _area: 0
    actions:
    - {name: compute, arguments: {energy: 0.084e-12}}
    constraints: {misc: {enabled: len(All()) == 3}}
