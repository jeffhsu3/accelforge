arch:
  version: "0.5"
  nodes:
  - !Memory
    name: MainMemory
    attributes: 
      _size: inf
      # https://www.jedec.org/news/pressreleases/jedec-updates-standard-low-power-memory-devices-lpddr5
      _latency: (read_actions + write_actions) / (8 * 38.4e9) # 38.4 GB/s. DDR5-4800. Chip runs at at 1GHz, so divide to get per-cycle bwidth
      _datawidth: 8
      _leak_power: 0
    actions:
      # Upper end of the range from the TPU paper. The lower end came from their
      # reference, and they said it left out some things.
    - {name: read, arguments: {energy: 7.03e-12}}
    - {name: write, arguments: {energy: 7.03e-12}}
    constraints: {tensors: {keep: ~Intermediates, may_keep: All}}
        

  - !Memory
    name: GlobalBuffer
    attributes:
      _size: 1024*64*8 # 64 kB
      _datawidth: 8
      _latency: max(read_actions * 512e9, write_actions * 128e9) # 512 GB/s read, 128 GB/s write
      _leak_power: 0
    actions:
    - {name: read, arguments: {energy: 0.249e-12}}
    - {name: write, arguments: {energy: 0.293e-12}}
    constraints:
      tensors:
        keep: All
      dataflow:
        tensor_order_options:
        - [~weight, weight]

  - !Memory
    name: ArrayDummy
    attributes: {_size: 0, _area: 0, _leak_power: 0, _energy: 0}
    spatial:
    - {name: reuse_input, fanout: 32, reuse: input} # 8 is the datawidth
    - {name: reuse_output, fanout: 192, reuse: output}
    constraints:
      tensors: {keep: Nothing}
      spatial:
      - {name: reuse_input, must_reuse: input, min_utilization: 1}
      - {name: reuse_output, must_reuse: output, min_utilization: 1}

  - !Memory
    name: Register
    attributes: {_size: 1, _area: 0, _leak_power: 0, _energy: 0}
    constraints: {tensors: {keep: weight}}

  - !Compute
    name: MAC
    attributes: {_latency: compute_actions, _leak_power: 0}
    actions:
    - {name: compute, arguments: {energy: 0.084e-12}}
