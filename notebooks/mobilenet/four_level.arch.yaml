variables:
  global_cycle_period: 1e-9
  tech_node: 7e-9

arch:
  version: "0.5"
  nodes:
  - !Memory
    name: MainMemory
    component_class: DRAM
    attributes:
      size: 9999999999999
      width: 4678 # 614 GB/s at 1.05GHz
      datawidth: 8
      area: 1
    constraints:
      storage:
        keep: ~Intermediates() {% if FFMT | default(false) %} | weight {% endif %}
    actions:
      # Upper end of the range from the TPU paper. The lower end came from their
      # reference, and they said it left out some things.
    - {name: read, arguments: {energy: 7.03}}
    - {name: write, arguments: {energy: 7.03}}
    - {name: leak, arguments: {energy: 0}}

  - !Memory
    name: GlobalBuffer
    component_class: SRAM
    attributes:
      size: 1024*1024*128*8 # 128MB
      width: 8192
      datawidth: 8
      area: 1
    constraints:
      storage:
        keep: ~MainMemory.tensors() | input | output
      {% if FFMT | default(false) %}
      dataflow:
        storage_orders:
        - [weight, input, output]
        - [weight, output, input]
      {% endif %}
    actions:
    - {name: read, arguments: {energy: 1.88}}
    - {name: write, arguments: {energy: 2.36}}
    - {name: leak, arguments: {energy: 0}}

  - !Memory
    name: LocalBuffer
    component_class: SRAM 
    spatial: [{name: X, fanout: 4}]
    attributes:
      size: 1024*1024*4*8 # 4MB
      width: 2048
      datawidth: 8
      area: 1
    constraints:
      storage:
        keep: Intermediates() - weight
        bypass: weight
      dataflow:
        storage_orders:
        - [All()] # No uneven. Put all tensors at the same level.
      spatial:
        - name: X
          loop_bounds:
          - expression: weight.rank_variables()
            operator: ==
            value: 1
    actions:
    - {name: read, arguments: {energy: 0.249}}
    - {name: write, arguments: {energy: 0.293}}
    - {name: leak, arguments: {energy: 0}}


  # - !Memory
  #   name: Reg2
  #   component_class: SRAM
  #   attributes:
  #     size: 99999999999
  #     datawidth: 8
  #     area: 0
  #   constraints:
  #     storage:
  #       keep: All()
  #       tile_shape:
  #       - expression: parallel_rank | reduced_rank
  #         operator: ==
  #         value: 128
  #       - expression: ~(parallel_rank | reduced_rank)
  #         operator: ==
  #         value: 1
  #     dataflow:
  #       storage_orders:
  #       - [input, output, weight]
  #   actions:
  #   - {name: read, arguments: {energy: 0}}
  #   - {name: write, arguments: {energy: 0}}
  #   - {name: leak, arguments: {energy: 0}}

  - !Memory
    name: Register
    component_class: dummy_storage
    spatial: [{name: X, fanout: 128}, {name: Y, fanout: 128}]
    attributes:
      size: 8 # 8b
      datawidth: 8
      width: 8
      depth: 1000
      area: 1
    constraints:
      storage:
        keep: weight
        bypass: ~weight
        tile_shape:
        - expression: weight.rank_variables()
          operator: ==
          value: 1
      dataflow:
        storage_orders:
        - [All()] # Outputs more stationary than inputs
      spatial:
        - name: X # Parallel rank
          min_utilization: 1 # 0.9
          loop_bounds:
          - expression: ~parallel_rank
            operator: ==
            value: 1
        - name: Y # Reduced rank. No iteration over outputs
          min_utilization: 1 # 0.9
          loop_bounds:
          - expression: ~reduced_rank
            operator: ==
            value: 1
    actions:
    - {name: read, arguments: {energy: 0}}
    - {name: write, arguments: {energy: 0}}
    - {name: leak, arguments: {energy: 0}}

  - !Compute
    name: MAC
    component_class: intmac
    attributes: {multiplier_width: 8, adder_width: 16, area: 1}
    actions:
    - {name: compute, arguments: {energy: 0.84}}
    - {name: leak, arguments: {energy: 0}}

components:
  version: "0.5"         # REQUIRED version number
  components:
  - name: intmac
    attributes:
      tech_node: REQUIRED
      multiplier_width: REQUIRED
      adder_width: REQUIRED
      global_cycle_period: REQUIRED
    subcomponents:
    - name: intadder
      component_class: aladdin_adder
      attributes: {width: adder_width}
    - name: intmultiplier
      component_class: aladdin_multiplier
      attributes: {width_a: multiplier_width, width_b: multiplier_width}
    actions:
    - name: compute
      subcomponents:
      - name: intadder
        actions: [name: read]
      - name: intmultiplier
        actions: [{name: read}]
    - name: leak
      subcomponents:
      - name: intadder
        actions: [{name: leak}]
      - name: intmultiplier
        actions: [{name: leak}]
