renames:
  einsums:
  - name: default
    tensor_accesses:
    - name: input
      source: Inputs() & Intermediates()
      expected_count: 1
    - name: output
      source: Outputs()
      expected_count: 1
    - name: weight
      source: ~(input | output)
      expected_count: 1

workload:
  version: "0.5"
  shape:
    {% set BATCH_SIZE = BATCH_SIZE | default(1) %}
    b: 0 <= b < {{BATCH_SIZE}}
    {% set N_TOKENS = N_TOKENS | default(8192) %}
    m: 0 <= m < {{N_TOKENS}} # = b
    p: 0 <= p < {{N_TOKENS}} # = m
    h: 0 <= h < 32
    e: 0 <= e < 128
    f: 0 <= f < 128
    d: 0 <= d < 4096 # = e * h
    c: 0 <= c < 16384
    j: 0 <= j < 4096
    g: 0 <= g < 4096

  einsums:
  - name: I
    is_copy_operation: True
    tensor_accesses:
    - {name: I_in, projection: [b, m, d]}
    - {name: I, projection: [b, m, d], output: True}
    renames: {weight: Nothing(), input: Inputs(), output: Outputs()}


  - name: V
    tensor_accesses:
    - {name: I, projection: [b, m, d]}
    - {name: WV, projection: [h, e, d]}
    - {name: V, projection: [b, m, h, e], output: True}

  - name: K
    tensor_accesses:
    - {name: I, projection: [b, m, d]}
    - {name: WK, projection: [h, e, d]}
    - {name: K, projection: [b, m, h, e], output: True}

  - name: Q
    tensor_accesses:
    - {name: I, projection: [b, m, d]}
    - {name: WQ, projection: [h, e, d]}
    - {name: Q, projection: [b, m, h, e], output: True}

  - name: QK
    tensor_accesses:
    - {name: Q, projection: [b, m, h, e]}
    - {name: K, projection: { B: b, M: p, H: h, E: e }}
    - {name: QK, projection: [b, m, p, h], output: True}
    renames: {weight: K, input: Q, output: QK}

  - name: QK_softmax
    tensor_accesses:
    - {name: QK, projection: [b, m, p, h]}
    - {name: QK_softmax, projection: [b, m, p, h], output: True}
    renames: {weight: Nothing()}

  - name: AV
    tensor_accesses:
    - {name: QK_softmax, projection: [b, m, p, h]}
    - {name: V, projection: { B: b, M: p, H: h, E: f}}
    - {name: AV, projection: [b, m, h, f], output: True}
    renames: {weight: V, input: QK_softmax}

  - name: Z
    tensor_accesses:
    - {name: AV, projection: [b, m, h, f]}
    - {name: WZ, projection: [h, f, g]}
    - {name: Z, projection: [b, m, g], output: True}

  - name: FFA
    tensor_accesses:
    - {name: Z, projection: [b, m, g]}
    - {name: WFFA, projection: [g, c]}
    - {name: FFA, projection: [b, m, c], output: True}

  - name: FFB
    tensor_accesses:
    - {name: FFA, projection: [b, m, c]}
    - {name: WFFB, projection: [c, j]}
    - {name: FFB, projection: [b, m, j], output: True}