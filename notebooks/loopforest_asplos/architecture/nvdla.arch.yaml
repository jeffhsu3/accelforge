arch:
  version: "0.5"
  global_cycle_period: 1/1.05e9
  nodes:
  - !Memory
    name: MainMemory
    attributes:
      _size: inf
      # https://www.jedec.org/news/pressreleases/jedec-updates-standard-low-power-memory-devices-lpddr5
      _bandwidth_reads_plus_writes_per_cycle: 8 * 38.4e9 / 1e9 # 38.4 GB/s. DDR5-4800. Chip runs at at 1GHz, so divide to get per-cycle bwidth
      _datawidth: 8
    actions:
      # Upper end of the range from the TPU paper. The lower end came from their
      # reference, and they said it left out some things.
    - {name: read, arguments: {energy: 7.03e-12}}
    - {name: write, arguments: {energy: 7.03e-12}}
    - {name: leak, arguments: {energy: 0}}
    constraints:
      tensors:
        keep: ~Intermediates()

  - !Memory
    name: GlobalBuffer
    attributes:
      _size: 1024*64*8 # 64 kB
      _datawidth: 8
      # _bandwidth_reads_per_cycle: 512 * 8e9 / 1e9 # 512 GB/s. Chip runs at at 1GHz, so divide to get per-cycle bandwidth
      # _bandwidth_writes_per_cycle: 256 * 4e9 / 1e9 # 256 GB/s. Chip runs at at 1GHz, so divide to get per-cycle bandwidth
    actions:
    - {name: read, arguments: {energy: 0.249e-12}}
    - {name: write, arguments: {energy: 0.293e-12}}
    - {name: leak, arguments: {energy: 0}}
    constraints:
      tensors:
        keep: All()
      dataflow:
        tensor_order_options:
        - [~weight, weight]

  # - !Memory
  #   name: LocalBuffer
  #   attributes:
  #     _size: 1024*512*8 # 512 kB
  #     _datawidth: 8
  #   actions:
  #   - {name: read, arguments: {energy: 0.249e-12}}
  #   - {name: write, arguments: {energy: 0.293e-12}}
  #   - {name: leak, arguments: {energy: 0}}
  #   constraints:
  #     tensors:
  #       keep: All()

  - !Memory
    name: Register
    spatial: [{name: X, fanout: 32}, {name: Y, fanout: 192}]
    attributes:
      _size: 8 # 8b
      _datawidth: 8
    actions:
    - {name: read, arguments: {energy: 0}}
    - {name: write, arguments: {energy: 0}}
    - {name: leak, arguments: {energy: 0}}
    constraints:
      tensors:
        bypass: ~weight
      spatial:
      - name: X # Parallel rank
        # min_utilization: 1
        loop_bounds:
        - expression: ~output_channel
          operator: ==
          value: 1
      - name: Y # Reduced rank. No iteration over outputs
        # min_utilization: 1
        loop_bounds:
        - expression: ~input_channel
          operator: ==
          value: 1

  - !Compute
    name: MAC
    actions:
    - {name: compute, arguments: {energy: 0.084e-12}}
    - {name: leak, arguments: {energy: 0}}
    constraints: {misc: {enabled: len(All()) == 3}}
