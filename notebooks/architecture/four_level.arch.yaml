variables:
  global_cycle_seconds: 1e-9
  technology: "7nm"

architecture:
  version: "0.5"
  nodes:
  - !Memory
    name: MainMemory
    component_class: DRAM
    attributes:
      size: 9999999999999
      width: 4678 # 614 GB/s at 1.05GHz
      datawidth: 8
      # Upper end of the range from the TPU paper. The lower end came from their
      # reference, and they said it left out some things.
      area: 1
    constraints:
      storage:
        keep: ~Intermediates()
    actions:
    - {name: read, arguments: {energy: 7.03}}
    - {name: write, arguments: {energy: 7.03}}
    - {name: leak, arguments: {energy: 0}}

  - !Memory
    name: GlobalBuffer
    component_class: SRAM
    attributes:
      size: 1024*1024*128*8 # 128MB
      width: 8192
      datawidth: 8
      depth: 1000 
      area: 1
    constraints:
      storage:
        keep: ~MainMemory.tensors()
    actions:
    - {name: read, arguments: {energy: 7.53}}
    - {name: write, arguments: {energy: 9.44}}
    - {name: leak, arguments: {energy: 0}}

  - !Memory
    name: LocalBuffer
    component_class: SRAM 
    spatial: {fanout_X: 16}
    attributes:
      size: 1024*1024*32*8 # 32MB
      width: 2048
      depth: 1000
      datawidth: 8
      area: 1
    constraints:
      storage:
        keep: Intermediates()
      spatial:
        loop_bounds:
        - expression: All().rank_variables()
          operator: product<=
          value: 16
    actions:
    - {name: read, arguments: {energy: 3.98}}
    - {name: write, arguments: {energy: 4.69}}
    - {name: leak, arguments: {energy: 0}}

  - !Memory
    name: Register
    component_class: dummy_storage
    spatial: {fanout_X: 128, fanout_Y: 128}
    attributes:
      size: 8 # 8b
      datawidth: 8
      width: 8
      depth: 1000
      area: 1
    constraints:
      storage:
        keep: weight
        bypass: ~weight
        # tile_size:
        # - [weight.rank_variables(), ==, 1]
      spatial_X:
        loop_bounds:
        - expression: input.rank_variables()
          operator: ==
          value: 1
      spatial_Y:
        loop_bounds:
        - expression: output.rank_variables()
          operator: ==
          value: 1
    actions:
    - {name: read, arguments: {energy: 0}}
    - {name: write, arguments: {energy: 0}}
    - {name: leak, arguments: {energy: 0}}

  - !Compute
    name: MAC
    component_class: intmac
    attributes: {multiplier_width: 8, adder_width: 16, area: 1}
    actions:
    - {name: compute, arguments: {energy: 0.84}}
    - {name: leak, arguments: {energy: 0}}

component_classes:
  version: "0.5"         # REQUIRED version number
  component_classes:
  - name: intmac
    attributes:
      technology: REQUIRED
      multiplier_width: REQUIRED
      adder_width: REQUIRED
      global_cycle_seconds: REQUIRED
    subcomponents:
    - name: intadder
      component_class: aladdin_adder
      attributes: {width: adder_width}
    - name: intmultiplier
      component_class: aladdin_multiplier
      attributes: {width_a: multiplier_width, width_b: multiplier_width}
    actions:
    - name: compute
      subcomponents:
      - name: intadder
        actions: [name: read]
      - name: intmultiplier
        actions: [{name: read}]
    - name: leak
      subcomponents:
      - name: intadder
        actions: [{name: leak}]
      - name: intmultiplier
        actions: [{name: leak}]
