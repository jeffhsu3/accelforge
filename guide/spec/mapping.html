
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mapping Specification &#8212; accelforge 0.1.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=fd6eb6e6"></script>
    <script src="../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@4/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'guide/spec/mapping';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Workload and Renames Specification" href="workload.html" />
    <link rel="prev" title="Arch Specification" href="architecture.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.svg" class="logo__image only-light" alt="accelforge 0.1.0 documentation - Home"/>
    <img src="../../_static/logo.svg" class="logo__image only-dark pst-js-only" alt="accelforge 0.1.0 documentation - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../citation.html">
    Citing AccelForge
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../guide.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../modules.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../citation.html">
    Citing AccelForge
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../contributing.html">
    Contributing
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../spec.html">Input Specifications</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Arch Specification</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Mapping Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="workload.html">Workload and Renames Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parsing/evaluation.html">Expression Evaluation</a></li>

<li class="toctree-l2"><a class="reference internal" href="../parsing/yaml_parsing.html">YAML Parsing</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../modeling.html">How Modeling Works</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../modeling/component_energy_area.html">Component Energy and Area</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modeling/accelerator_energy_latency.html">Accelerator Energy, Area, and Latency</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modeling/mapping.html">Mapping with Fast &amp; Fusiest</a></li>

</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../definitions.html">Definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faqs.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timeloop_compare.html">Migrating from Timeloop</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../guide.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="../spec.html" class="nav-link">Input Specifications</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Mapping Specification</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="mapping-specification">
<span id="specifying-mapping"></span><h1>Mapping Specification<a class="headerlink" href="#mapping-specification" title="Link to this heading">#</a></h1>
<p>A <em>mapping</em> is the scheduling (in both time and space) of operations in every
computation step in a workload on an architecture. Mappings in AccelForge are written in
LoopTree notation (in Python and YAML equivalents). This documentation covers the
LoopTree notation, and how to write LoopTrees in YAML (and the equivalent Python class).</p>
<section id="the-looptree-notation">
<h2>The LoopTree Notation<a class="headerlink" href="#the-looptree-notation" title="Link to this heading">#</a></h2>
<p>To illustrate LoopTrees, consider the following cascade of two matrix-vector
multiplications:</p>
<div class="math notranslate nohighlight">
\[\begin{split}A_{nA} = I_{nI} \times WA_{nI,nA} \\
B_{nB} = A_{nA} \times WB_{nA,nB}\end{split}\]</div>
<p>Moreover, we will process these Einsums using an architecture consisting of two memory
levels: OffChipBuffer and OnChipBuffer. Moreover, this architecture has compute units
named ComputeUnit.</p>
<p>The following LoopTree shows loops belonging to each Einsum and which tensors are
reused.</p>
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span>mapping:
  nodes:
  - !Storage
    component: OffChipBuffer
    tensors: [I, WA, WB, B]
  - !Storage
    component: OnChipBuffer
    tensors: [WA]
  - !Temporal
    rank_variable: nA
    tile_shape: 1
  - !Storage
    component: OnChipBuffer
    tensors: [A]
  - !Sequential
    nodes:
    - !Nested
      nodes:
      - !Temporal
        rank_variable: nI
        tile_shape: 1
      - !Storage
        component: OnChipBuffer
        tensors: [I]
      - !Compute
        einsum: EinsumA
        component: ComputeUnit
    - !Nested
      nodes:
      - !Temporal
        rank_variable: nB
        tile_shape: 1
      - !Storage
        component: OnChipBuffer
        tensors: [B, WB]
      - !Compute
        einsum: EinsumB
        component: ComputeUnit
</pre></div>
</div>
<dl class="simple">
<dt>There are four node types in LoopTree:</dt><dd><ul class="simple">
<li><p><em>Loop nodes</em>, rectangles in the LoopTree, represent nested for loops that iterate
over rank variables in the workload. A loop may be shared between multiple fused
Einsums, such as the outer <span class="math notranslate nohighlight">\(nA\)</span> loop.</p></li>
<li><p><em>Storage nodes</em>, cylinders in the LoopTree, represent the storage for tensor
tiles.</p></li>
<li><p><em>Compute nodes</em>, ovals in the LoopTree, represent the Einsum computation that is
performed in that branch.</p></li>
<li><p>In this example, they represent the multiply-accumulate operations in the Einsums
A and B using ComputeUnit.</p></li>
<li><p><em>Splits</em> in the LoopTree represent points where two or more Einsums are processed
sequentially.</p></li>
</ul>
</dd>
</dl>
</section>
<section id="interpreting-looptrees">
<h2>Interpreting LoopTrees<a class="headerlink" href="#interpreting-looptrees" title="Link to this heading">#</a></h2>
<p>When interpreting LoopTrees, always keep the following rule in mind: <em>If we move storage
nodes lower in the LoopTree, then tile size, data reuse, and data lifetime stay the same
or decrease.</em></p>
<p>The following can be seen in LoopTrees:</p>
<ul class="simple">
<li><p><em>Tile size</em> for a tensor decreases if we move a storage node below a loop that indexes
into a rank of the tensor. For example, moving <span class="math notranslate nohighlight">\(WA_{kA,nA}\)</span> below the <span class="math notranslate nohighlight">\(nA\)</span>
loop decreases the tile size of <span class="math notranslate nohighlight">\(WA_{kA,nA}\)</span> because it only needs to store the
tile needed for one <span class="math notranslate nohighlight">\(nA\)</span> iteration.</p></li>
<li><p><em>Reuse</em> for a tensor tile decreases if we move a storage node below a loop that does
not index into a rank of the tensor. For example, moving <span class="math notranslate nohighlight">\(WA_{kA,nA}\)</span> below the
<span class="math notranslate nohighlight">\(m\)</span> loop causes <span class="math notranslate nohighlight">\(WA_{kA,nA}\)</span> to be re-fetched for each iteration of the
<span class="math notranslate nohighlight">\(m\)</span> loop, losing reuse.</p></li>
<li><p><em>Lifetime</em> of a tensor tile—how long a tensor tile lives in memory—decreases if we
move a storage node below a loop that is above a branch. For example, moving
<span class="math notranslate nohighlight">\(WA\)</span> below the <span class="math notranslate nohighlight">\(nA\)</span> loop but above the branch means <span class="math notranslate nohighlight">\(WA\)</span> tiles would
only be alive for the left branch, and could be freed before moving to the right
branch.</p></li>
<li><p><em>Fusion</em> of two Einsums can be seen in the LoopTree by the absence of the shared
tensor in off-chip storage node. For example, tensor <span class="math notranslate nohighlight">\(A\)</span> is not stored off-chip,
thus it is fused between Einsums A and B.</p></li>
</ul>
</section>
<section id="looptrees-in-yaml">
<h2>LoopTrees in YAML<a class="headerlink" href="#looptrees-in-yaml" title="Link to this heading">#</a></h2>
<p>Here, we discuss how a LoopTree mapping can be written as YAML text, and used as
input/output to AccelForge.</p>
<p>As a YAML text, each node is a YAML dictionary with a tag representing its node types.
For example, a compute node has the following format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">code</span><span class="o">-</span><span class="n">block</span><span class="p">::</span> <span class="n">yaml</span>
</pre></div>
</div>
<blockquote>
<div><p>!Compute  # this is a YAML tag
einsum: name-of-einsum-to-compute  # a YAML dictionary element “key: value”
component: name-of-compute-component-that-processes-the-einsum</p>
</div></blockquote>
<p>Detailed documentation of each node types can be found in the API documentation.</p>
<p>In YAML, subsequent nodes in a LoopTree can be written as a list, but this requires an
additional node type: <code class="docutils literal notranslate"><span class="pre">Nested</span></code>. To use a <code class="docutils literal notranslate"><span class="pre">Nested</span></code> node, simply place subsequent
nodes as the list elements of the <code class="docutils literal notranslate"><span class="pre">nodes</span></code> key:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">..</span> <span class="n">code</span><span class="o">-</span><span class="n">block</span><span class="p">::</span> <span class="n">yaml</span>
</pre></div>
</div>
<blockquote>
<div><p>!Nested
nodes:
- node_0
- node_1
- node_2</p>
</div></blockquote>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="architecture.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Arch Specification</p>
      </div>
    </a>
    <a class="right-next"
       href="workload.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Workload and Renames Specification</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-looptree-notation">The LoopTree Notation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#interpreting-looptrees">Interpreting LoopTrees</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#looptrees-in-yaml">LoopTrees in YAML</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/guide/spec/mapping.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 9.1.0.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>