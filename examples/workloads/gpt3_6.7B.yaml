# Each tensor is shaped by a set of ranks, denoted by capital letters
# For example: Q is shaped by (B, M, H, E)
# We'll use lower-case letters to index into the ranks
# For example: Q[b, m, h, e] is the tensor Q at index (b, m, h, e)

# When making a projection list, it's equivalent to the Einsum subscript notation, so:
# Q projection [b, m, h, e] means that b indexes into B, m indexes into M...
# When making a projection dict, it's equivalent to the Einsum subscript/superscript notation, so:
# K projection { B: b, M: p, H: h, E: e } means that b indexes into B, p indexes into M...

# Renames take a tensor name and turn them into a canonical name that we can use in
# architecture constraints. For example, we want to use the words "input", "weight", and
# "output" to refer to the tensors of an Einsum, but the Einsum QK has no clear "weight"
# or "input" because both Q and K are inputs. So we rename K to be weight.

workload:
  rank_sizes:
    {% set BATCH_SIZE = BATCH_SIZE | default(1) %}
    {% set N_TOKENS = N_TOKENS | default(8192) %}
    B: {{BATCH_SIZE}}
    P: {{N_TOKENS}}
    M: {{N_TOKENS}}
    H: 32
    E: 128
    F: 128
    D: 4096 # = e * h
    C: 16384
    J: 4096
    G: 4096

  bits_per_value: {All: 8}
  persistent_tensors: weight - Intermediates

  einsums:
  - einsum: "I[b, m, d] = I_in[b, m, d]"
    is_copy_operation: True
  - "V[b, m, h, e] = I[b, m, d] * WV[h, e, d]"
  - "K[b, m, h, e] = I[b, m, d] * WK[h, e, d]"
  - "Q[b, m, h, e] = I[b, m, d] * WQ[h, e, d]"
  - einsum: "QK[b, m, p, h] = Q[b, m, h, e] * K[b, M: p, h, e]"
    renames: {input: Q}
  - "QK_softmax[b, m, p, h] = QK[b, m, p, h]"
  - einsum: "AV[b, m, h, f] = QK_softmax[b, m, p, h] * V[b, M: p, h, E: f]"
    renames: {input: QK_softmax}
  - "Z[b, m, g] = AV[b, m, h, f] * WZ[h, f, g]"
  - "FFA[b, m, c] = Z[b, m, g] * WFFA[g, c]"
  - "FFB[b, m, j] = FFA[b, m, c] * WFFB[c, j]"

renames:
  einsums:
  - name: default
    tensor_accesses:
    - name: input
      source: Inputs & Intermediates if len(All) == 3 else Inputs
      expected_count: 1
    - name: output
      source: Outputs
      expected_count: 1
    - name: weight
      source: ~(input | output)
      expected_count: 1 if len(All) == 3 else 0
