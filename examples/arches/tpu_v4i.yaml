arch:
  nodes:
  - !Memory
    name: MainMemory
    size: inf
    leak_power: 0
    area: 0 # Don't include off-chip DRAM area
    actions:
      # Upper end of the range from the TPU paper. The lower end came from their
      # reference, and they said it left out some things.
    - {name: read, energy: 7.03e-12, latency: 1 / (8 * 614e9)}
    - {name: write, energy: 7.03e-12, latency: 1 / (8 * 614e9)}
    tensors: {keep: ~Intermediates, may_keep: All}

  - !Memory
    name: GlobalBuffer
    size: 1024*1024*128*8 # 128MB
    total_latency: max(read_latency, write_latency) # Separate ports
    leak_power: 0
    area: 112e-6 # 112 mm^2
    actions:
    - {name: read, energy: 1.88e-12, latency: 1 / (8 * 2048e9)}
    - {name: write, energy: 2.36e-12, latency: 1 / (8 * 1024e9)}
    tensors: {keep: ~MainMemory.tensors, may_keep: All}

  - !Memory
    name: LocalBuffer
    spatial: [{name: Z, fanout: 4, may_reuse: Nothing, min_usage: 1}]
    size: 1024*1024*4*8 # 4MB
    leak_power: 0
    area: 50e-6 # 50 mm^2. Very rough estimate based on die photo.
    actions:
    - {name: read, energy: 0.249e-12, latency: 0}
    - {name: write, energy: 0.293e-12, latency: 0}
    tensors: {keep: input | output}

  - !Compute
    name: ScalarUnit
    area: 10e-6 # 10 um^2. Very rough estimate based on die photo.
    leak_power: 0
    actions:
    - {name: compute, energy: 0, latency: 1 / 1.05e9 / 128}
    enabled: len(All) == 2

  - !Container
    name: PE
    spatial:
    - {name: reuse_input, fanout: 128, may_reuse: input, reuse: input, min_usage: 1}
    - {name: reuse_output, fanout: 128, may_reuse: output, reuse: output, min_usage: 1}

  - !Memory
    name: Register
    size: weight.bits_per_value if weight else 0
    area: 1e-11 # 10 um^2. Very rough estimate based on die photo.
    leak_power: 0
    actions:
    - {name: read, energy: 0, latency: 0}
    - {name: write, energy: 0, latency: 0}
    tensors: {keep: weight}

  - !Compute
    name: MAC
    leak_power: 0
    area: 9e-11 # 90 um^2. Very rough estimate based on die photo.
    actions:
    - {name: compute, energy: 0.084e-12, latency: 1 / 1.05e9}
    enabled: len(All) == 3
