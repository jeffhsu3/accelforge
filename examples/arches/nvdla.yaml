arch:
  nodes:
  - !Memory
    name: MainMemory
    attributes:
      _size: inf
      _leak_power: 0
    actions:
      # Energy is upper end of the range from the TPU paper. The lower end came from
      # their reference, and they said it left out some things. Latency is 38.4 GB/s.
      # DDR5-4800. Chip runs at at 1GHz, so divide to get per-cycle bandwidth.
      # https://www.jedec.org/news/pressreleases/jedec-updates-standard-low-power-memory-devices-lpddr5
    - {name: read, arguments: {_energy: 7.03e-12, _latency: 1 / (8 * 38.4e9)}}
    - {name: write, arguments: {_energy: 7.03e-12, _latency: 1 / (8 * 38.4e9)}}
    tensors: {keep: ~Intermediates, may_keep: All}

  - !Memory
    name: GlobalBuffer
    attributes:
      _size: 1024*64*8 # 64 kB
      _total_latency: max(read_latency, write_latency) # Separate ports
      _leak_power: 0
    actions:
    # 512 GB/s read, 128 GB/s write
    - {name: read, arguments: {_energy: 0.249e-12, _latency: 1 / 512e9 / 8}}
    - {name: write, arguments: {_energy: 0.293e-12, _latency: 1 / 128e9 / 8}}
    tensors: {keep: All}

  - !Fanout
    name: ArrayFanout
    spatial:
    - {name: reuse_input, fanout: 32, may_reuse: input, reuse: input, min_usage: 1}
    - {name: reuse_output, fanout: 192, may_reuse: output, reuse: output, min_usage: 1}

  - !Memory
    name: Register
    attributes: {_size: weight.bits_per_value, _area: 0, _leak_power: 0}
    actions:
    - {name: read, arguments: {_energy: 0, _latency: 0}}
    - {name: write, arguments: {_energy: 0, _latency: 0}}
    tensors: {keep: weight}

  - !Compute
    name: MAC
    attributes: {_leak_power: 0}
    actions:
    - {name: compute, arguments: {_energy: 0.084e-12, _latency: 1 / 1e9}}
